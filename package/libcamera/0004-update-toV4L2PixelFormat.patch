From 62bce91263c747e42d39bcaa6a15f03458c38e70 Mon Sep 17 00:00:00 2001
From: sw.multimedia <sw.multimedia@starfivetech.com>
Date: Tue, 16 Nov 2021 17:23:17 +0800
Subject: [PATCH] update toV4L2PixelFormat

---
 src/libcamera/pipeline/starfive/starfive.cpp | 18 ++++++++++++------
 1 file changed, 12 insertions(+), 6 deletions(-)

diff --git a/src/libcamera/pipeline/starfive/starfive.cpp b/src/libcamera/pipeline/starfive/starfive.cpp
index 36ef3b7b..159ead04 100644
--- a/src/libcamera/pipeline/starfive/starfive.cpp
+++ b/src/libcamera/pipeline/starfive/starfive.cpp
@@ -441,7 +441,8 @@ CameraConfiguration::Status StarFiveCameraConfiguration::validate()
 				&& data_->haveRaw()) {
 			V4L2DeviceFormat format = {};
 			format.fourcc =
-				data_->raw_->toV4L2PixelFormat(cfg.pixelFormat);
+				V4L2PixelFormat::fromPixelFormat(cfg.pixelFormat,
+						data_->raw_->caps().isMultiplanar());
 			format.size = cfg.size;
 
 			int ret = data_->raw_->tryFormat(&format);
@@ -455,7 +456,8 @@ CameraConfiguration::Status StarFiveCameraConfiguration::validate()
 		} else {
 			V4L2DeviceFormat format = {};
 			format.fourcc =
-				data_->video_->toV4L2PixelFormat(cfg.pixelFormat);
+				V4L2PixelFormat::fromPixelFormat(cfg.pixelFormat,
+						data_->video_->caps().isMultiplanar());
 			format.size = cfg.size;
 
 			int ret = data_->video_->tryFormat(&format);
@@ -572,7 +574,8 @@ int PipelineHandlerStarFive::configure(Camera *camera, CameraConfiguration *c)
 		if (stream == &data->rawStream_) {
 			V4L2DeviceFormat format = {};
 			format.fourcc =
-				data->raw_->toV4L2PixelFormat(cfg.pixelFormat);
+				V4L2PixelFormat::fromPixelFormat(cfg.pixelFormat,
+						data->raw_->caps().isMultiplanar());
 			format.size = cfg.size;
 
 			ret = data->raw_->setFormat(&format);
@@ -581,13 +584,15 @@ int PipelineHandlerStarFive::configure(Camera *camera, CameraConfiguration *c)
 
 			if (format.size != cfg.size ||
 			    format.fourcc !=
-			    data->raw_->toV4L2PixelFormat(cfg.pixelFormat))
+			    V4L2PixelFormat::fromPixelFormat(cfg.pixelFormat,
+				    data->raw_->caps().isMultiplanar()))
 				return -EINVAL;
 
 		} else if (stream == &data->outStream_) {
 			V4L2DeviceFormat format = {};
 			format.fourcc =
-				data->video_->toV4L2PixelFormat(cfg.pixelFormat);
+				V4L2PixelFormat::fromPixelFormat(cfg.pixelFormat,
+						data->video_->caps().isMultiplanar());
 			format.size = cfg.size;
 
 			ret = data->video_->setFormat(&format);
@@ -596,7 +601,8 @@ int PipelineHandlerStarFive::configure(Camera *camera, CameraConfiguration *c)
 
 			if (format.size != cfg.size ||
 			    format.fourcc !=
-			    data->video_->toV4L2PixelFormat(cfg.pixelFormat))
+			    V4L2PixelFormat::fromPixelFormat(cfg.pixelFormat,
+				    data->video_->caps().isMultiplanar()))
 				return -EINVAL;
 		}
 
-- 
2.17.1

